---
title: Management and analysis of physics datasets, Part. 1 
subtitle: Fifth Laboratory
author: Antonio Bergnoli  bergnoli@pd.infn.it
date: 18/12/2019
logo: images/INFNlogo2017.png
toc: true

---
# Laboratory Introduction

## Goals

-   Become familiar with SPI protocol.

-   Serial Flash Memory as SPI slave.

# SPI

## SPI - Wiki

![](images/spi_1){width="100%"}

![](images/spi_2){width="100%"}

## SPI (1)

-   SPI (Serial Peripheral Interface) :

    -   it is serial: the data is transmitted one bit at a time;

    -   it is synchronous: the transmission of the data is imposed by
        the clock;

    -   it has an architecture master/slave(s);

-   It is a basic serial protocol (not the most).

-   It is mostly used for the communication between $\mathrm{\mu}$C or
    FPGA and ICs like: A/D, D/A converters, sensors, memories \...

## SPI (2)

![](images/spi_schema){width="100%"}

-   The data are exchanged between a master and a slave.

-   Essentially each device has inside it a shift register with the
    data. The data transmission \"exchanges\" the data between the shift
    registers.

-   The Master addresses the Slave and it manages the data transmission
    with the clock (on the **rising edge**).

## SPI (3) SPI signals (from the slave side):

-   **CS** or **SS**: Chip (Slave) Select. When this input signal is
    low, the device is selected.

-   **CLK**: Clock. This input signal provides the timing for the serial
    interface. Instructions, addresses, or data present at the MOSI are
    latched (evaluated) on the rising edge of the clock.

-   **MOSI**: Master Output Slave Input. This input signal is used to
    transfer data serially into the device. It receives instructions,
    addresses, and the data to be programmed.

-   **MISO**: Master Input Slave Output. This output signal is used to
    transfer data serially out of the device.

## SPI (4)

![](images/board){width="80%"}

# Serial Flash Memory

## Flash Memory

![](images/flash){width="100%"}

## Flash Memory - Organization

![](images/org){width="100%"}

-   $16777216 = 2^{24}$;

-   Therefore the address of each 8-bit register is a 24-bit address.

## Flash Memory - Read (1) 

To read the memory content in SPI protocol
different instructions are available: READ, Fast Read, Dual Output Fast
Read, Dual Input Output Fast Read, Quad Output Fast Read and Quad Input
Output Fast read, allowing the application to choose an instruction to
send addresses and receive data by one, two or four data lines.

![](images/table){width="100%"}

## Flash Memory - Read (2)

![](images/read){width="100%"}

## Flash Memory - Read (3)

-   The device is selected by driving the CS low.

-   The instruction code for the READ instruction ($00000011_2$) is
    sent. Each bit is latched-in (evaluated) on the rising edge of the
    clock.

-   The 3 bytes address (23,22,\...,1,0) are then sent. Each bit is
    latched-in (evaluated) on the rising edge of the clock.

-   Then the memory content, at that address, is shifted out on the
    MISO, each bit is sent, on the falling edge of Serial Clock (C). But
    evaluated by the Master on the following rising-edge.

-   The READ instruction is terminated by driving the CS high.

# Homework

## Homework

-   **You have to write the VHDL code to implement an SPI master, in
    order to read the data stored in a 8-bit register of the serial
    flash memory.**

![](images/master){width="50%"}

## Hmw - Master signals (1)

-   clock: the clock provided by the oscillator mounted on the
    evaluation board;

-   miso;

-   reset: provided by the VIO. It is used to reset the FSM;

-   start: provided by the VIO. It is used to start the READ operation,
    on the rising edge of the signal;

-   txd: a 32 bit signals. It is formed by the the instruction byte and
    the address 3 bytes. The address (or rather the last 4 significant
    bits) is provided by the VIO;

## Hmw - Master signals (2)

-   cs: when you have received the 8 bits stored in a register, after
    the read operation, the CS has to switch from '0' to '1';

-   mosi;

-   ready: the ready is a pulse '0' $\rightarrow$ '1' $\rightarrow$ '0'
    that happens when you have received the 8 bits stored in a register,
    after the read operation;

-   rxd: a 8 bit signals. It is formed by the 8 bits obtained by the
    read operation;

-   sclk: is the clock generated by the master, that synchronizes the
    data transmission.

## Memory Configuration

-   The flash memory must be configured using the .mcs file in the
    folder $flash\_configuration$. With this .mcs file you are going to
    write the first six flash memory locations with these values:

    1.  @ address 0x000000 $\Rightarrow$ 0x00;

    2.  @ address 0x000001 $\Rightarrow$ 0x01;

    3.  @ address 0x000002 $\Rightarrow$ 0x02;

    4.  @ address 0x000003 $\Rightarrow$ 0x03;

    5.  @ address 0x000004 $\Rightarrow$ 0x04;

    6.  @ address 0x000005 $\Rightarrow$ 0x05.

-   **0x** stands for hexadecimal value.

-   The configuration of the flash memory using in the .mcs file is
    described in the section 3 of the third laboratory.

## Hints (1)

-   You can download all the folder $Lab8$, open the project (the file
    .xpr) and work there.

-   You have to write the code **only** inside the file
    $spi\_master.vhd$.

-   The SPI master can be implemented as a 3 state FSM.

-   **Remember** the testbenches !!!

## Hints (2)

You can use this code as an inspirational source for you code.
It is a **partial** implementation of a state of the FSM. In particular
in this state the txd word is transmitted to the slave.

![](images/code){width="100%"}

## Hints (3) 
It might be very useful exploit the ILA core(s) in order to
monitor the state of the FSM, the internal signals and the signals
representing the SPI master inputs and output.\
**For the final check instantiates an ILA core, where you monitor the
CS, the MOSI, the MISO and the SCLK. You must get a temporal diagram
very similar to the diagram of the picture/ slide 15.** Monitor also the
\"ready\" signal.

![](images/ila){width="100%"}
